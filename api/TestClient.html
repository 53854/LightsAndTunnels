<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Puzzle Template Test Client</title>
  <style>
    :root {
      --bg: #101418;
      --panel: #1a222b;
      --text: #e6eef7;
      --muted: #9fb0c2;
      --accent: #4fa3ff;
      --border: #2a3642;
      --ok: #4caf50;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }
    .page {
      max-width: 820px;
      margin: 24px auto;
      padding: 0 16px 24px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
    }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .sub { color: var(--muted); font-size: 13px; margin-bottom: 14px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0f1720;
      color: var(--text);
    }
    .field { flex: 1 1 240px; }
    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #18212a;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s ease;
    }
    button.primary {
      background: linear-gradient(120deg, #4fa3ff, #2563eb);
      border-color: #3b82f6;
      color: #0b1320;
    }
    button:hover { filter: brightness(1.05); }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }
    .status-pill.ok { color: #d1fae5; border-color: rgba(76,175,80,0.5); }
    .status-pill.warn { color: #fef3c7; border-color: rgba(245,158,11,0.5); }
    .log {
      font-family: Consolas, "Courier New", monospace;
      background: #0d141b;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      max-height: 180px;
      overflow: auto;
      color: #b8c7d8;
    }
    .log .entry { margin-bottom: 6px; }
    .log .entry:last-child { margin-bottom: 0; }
    .preview {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-start;
      margin-top: 12px;
    }
    .preview img {
      max-width: 100%;
      width: 320px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1720;
      object-fit: contain;
    }
    .preview .meta {
      font-size: 12px;
      color: var(--muted);
      min-width: 160px;
    }
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>Puzzle Template Test Client</h1>
      <div class="sub">Simple GUI to test WindowsPuzzleTemplate functions.</div>
      <div class="row">
        <div class="field">
          <label for="base-url">Template URL</label>
          <input id="base-url" type="text" value="http://localhost:5001">
        </div>
        <button id="refresh-btn">Refresh Status</button>
      </div>
      <div style="margin-top:12px;">
        <span class="status-pill" id="state-pill">State: --</span>
        <span class="status-pill" id="ext-pill">External Check: --</span>
      </div>
    </div>

    <div class="card">
      <h1>Password Output</h1>
      <div class="sub">Stores output data in the template (uses /setOutput).</div>
      <div class="row">
        <div class="field">
          <label for="password-value">Password</label>
          <input id="password-value" type="text" placeholder="e.g. 1234">
        </div>
        <button class="primary" id="send-password">Set Password Output</button>
      </div>
    </div>

    <div class="card">
      <h1>Incoming Media</h1>
      <div class="sub">Displays incoming media inputs (auto-detected).</div>
      <div class="row">
        <div class="field">
          <label for="media-server-url">Media Server URL</label>
          <input id="media-server-url" type="text" value="http://escapehub.local">
        </div>
        <label class="toggle">
          <input type="checkbox" id="auto-media-refresh" checked>
          Auto refresh
        </label>
        <button id="load-incoming-media">Refresh Now</button>
      </div>
      <div class="preview" id="incoming-media-list"></div>
    </div>

    <div class="card">
      <h1>Player Input</h1>
      <div class="sub">Sets the check value and triggers external check (uses /triggerExternalCheck).</div>
      <div class="row">
        <div class="field">
          <label for="player-input">Player Input</label>
          <input id="player-input" type="text" placeholder="value to verify">
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="primary" id="activate-player-input">Activate Player Input</button>
      </div>
    </div>

    <div class="card">
      <h1>Puzzle State</h1>
      <div class="sub">Manually mark the puzzle as solved.</div>
      <div class="row">
        <button class="primary" id="solve-puzzle">Solve Puzzle</button>
      </div>
    </div>

    <div class="card">
      <h1>Log</h1>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const baseUrlInput = document.getElementById("base-url");
    const statePill = document.getElementById("state-pill");
    const extPill = document.getElementById("ext-pill");
    const logEl = document.getElementById("log");
    const mediaServerInput = document.getElementById("media-server-url");
    const incomingList = document.getElementById("incoming-media-list");
    const autoMediaRefresh = document.getElementById("auto-media-refresh");
    let incomingRenderKey = "";

    function log(msg) {
      const entry = document.createElement("div");
      entry.className = "entry";
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.prepend(entry);
    }

    function apiUrl(path) {
      const base = (baseUrlInput.value || "").trim().replace(/\/+$/, "");
      return base + path;
    }

    async function post(path, payload) {
      const res = await fetch(apiUrl(path), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload || {})
      });
      return res.json();
    }

    async function get(path) {
      const res = await fetch(apiUrl(path), { cache: "no-store" });
      return res.json();
    }

    function mediaServerUrl(path) {
      const base = (mediaServerInput.value || "").trim().replace(/\/+$/, "");
      return base + path;
    }

    function renderIncomingMedia(items) {
      if (!incomingList) return;
      const renderKey = JSON.stringify(items);
      if (renderKey === incomingRenderKey) return;
      incomingRenderKey = renderKey;
      if (!items.length) {
        incomingList.innerHTML = `<div class="meta">No incoming media loaded.</div>`;
        return;
      }
      incomingList.innerHTML = items.map(item => {
        const url = item.resolved
          ? mediaServerUrl(`/media/${encodeURIComponent(item.resolved)}`)
          : "";
        const imgTag = item.resolved
          ? `<img src="${url}" alt="${item.ref}">`
          : `<div class="meta">Media not found on server.</div>`;
        return `
          <div>
            ${imgTag}
            <div class="meta">Key: ${item.key} · Ref: ${item.ref}${item.resolved ? ` · File: ${item.resolved}` : ""}</div>
          </div>`;
      }).join("");
    }

    async function refreshStatus() {
      try {
        const state = await get("/getState");
        statePill.textContent = `State: ${state.state || "--"}`;
        statePill.className = "status-pill" + (state.state === "running" ? " ok" : state.state === "solved" ? " ok" : "");
      } catch (e) {
        statePill.textContent = "State: error";
        statePill.className = "status-pill warn";
      }

      try {
        const ext = await get("/getExternalCheck");
        const active = !!ext.externalCheck?.active;
        const value = ext.externalCheck?.value;
        extPill.textContent = `External Check: ${active ? "active" : "inactive"}${value ? " (" + value + ")" : ""}`;
        extPill.className = "status-pill" + (active ? " ok" : "");
      } catch (e) {
        extPill.textContent = "External Check: error";
        extPill.className = "status-pill warn";
      }
    }

    document.getElementById("refresh-btn").addEventListener("click", () => {
      refreshStatus();
    });

    document.getElementById("send-password").addEventListener("click", async () => {
      const value = document.getElementById("password-value").value || "";
      try {
        await post("/setOutput", { key: "Password", type: "string", data: value });
        log(`Password output stored: ${value}`);
      } catch (e) {
        log("Failed to store password output.");
      }
      refreshStatus();
    });

    async function loadIncomingMedia() {
      try {
        const all = await get("/getAll");
        const inputs = all && all.inputs ? all.inputs : {};
        const puzzleState = (all && all.state ? all.state : "").toString().toLowerCase();
        if (!["running", "active", "uploading", "solved"].includes(puzzleState)) {
          renderIncomingMedia([]);
          return;
        }
        const keys = Object.keys(inputs).filter(k => inputs[k]?.type === "media");
        const items = [];
        for (const key of keys) {
          const ref = inputs[key]?.data;
          if (!ref) continue;
          let resolved = null;
          try {
            const resolveUrl = mediaServerUrl(`/api/media/resolve?name=${encodeURIComponent(ref)}`);
            const res = await fetch(resolveUrl);
            if (res.ok) {
              const data = await res.json();
              resolved = data?.name || null;
            }
          } catch (e) {}
          items.push({ key, ref, resolved });
        }
        renderIncomingMedia(items);
        if (items.length) {
          log(`Incoming media updated (${items.length}).`);
        }
      } catch (e) {
        log("Failed to load incoming media.");
      }
    }

    document.getElementById("load-incoming-media").addEventListener("click", async () => {
      await loadIncomingMedia();
    });

    document.getElementById("activate-player-input").addEventListener("click", async () => {
      const value = document.getElementById("player-input").value || "";
      try {
        await post("/triggerExternalCheck", { value, active: true });
        log(`External check activated with value: ${value}`);
      } catch (e) {
        log("Failed to activate external check.");
      }
      refreshStatus();
    });

    document.getElementById("solve-puzzle").addEventListener("click", async () => {
      try {
        await post("/setState", { state: "solved" });
        log("Puzzle marked as solved.");
      } catch (e) {
        log("Failed to set puzzle state.");
      }
      refreshStatus();
    });

    refreshStatus();
    setInterval(refreshStatus, 2000);
    setInterval(() => {
      if (autoMediaRefresh && autoMediaRefresh.checked) {
        loadIncomingMedia();
      }
    }, 2000);
  </script>
</body>
</html>
